unit uESocialInstancia;

interface

uses
  Vcl.OleCtrls, SysUtils, ESocialClientX_TLB, uConfiguracoes, uEvento, uS1000,
  uS1005;

type
  TeSocial = class
  private
    FComponente: TspdESocialClientX;
    FConfiguracao: TConfig;
    FEvento: TEvento;
    property Componente: TspdESocialClientX read FComponente write FComponente;
  public
    property Configuracao: TConfig read FConfiguracao write FConfiguracao;
    property Evento: TEvento read FEvento write FEvento;
    constructor Create;
    procedure configurarComponente();
    function assinarXML(const AAcao: Integer = 1; const ATx2: WideString = ''): WideString;
    function enviarEvento(const AAcao: Integer = 1; const ATx2: WideString = ''; const idGrupoEvento: SmallInt = 1): IspdRetEnviarLoteEventos;
    function consultarEventos(AEvento: WideString): IspdRetConsultarLote;
    function listarCertificados: string;
    procedure alterarEvento(AEvento: Integer);
    const
      INCLUIR = 1;
      EXCLUIR = 2;
      ALTERAR = 3;
      TX2 = 4;
    const
      S1000 = 1000;
      S1005 = 1005;
  end;

implementation

procedure TeSocial.alterarEvento(AEvento: Integer);
begin
  Evento := nil;
  Evento.Free;
  case AEvento of
    S1000:
      begin
        Evento := TS1000.Create;
      end;
    S1005:
      begin
        Evento := TS1005.Create;
      end;
  end;

end;

function TeSocial.assinarXML(const AAcao: Integer; const ATx2: WideString): WideString;
var
  Retorno: WideString;
begin
  if (AAcao = TX2) then
    Retorno := Componente.GerarXMLporTx2(ATx2)
  else
    Retorno := Componente.GerarXMLporTx2(Evento.gerarTX2(AAcao));

  Result := Componente.AssinarEvento(Retorno);
end;

procedure TeSocial.configurarComponente;
begin
  Componente.CpfCnpjTransmissor := Configuracao.CpfCnpjTransmissor;
  Componente.CpfCnpjEmpregador := Configuracao.CpfCnpjEmpregador;
  Componente.VersaoManual := Configuracao.VersaoManual;
  Componente.DiretorioTemplates := Configuracao.DiretorioTemplates;
  Componente.DiretorioEsquemas := Configuracao.DiretorioEsquemas;
  Componente.Ambiente := akPreProducaoReais;
  Componente.NomeCertificado := Configuracao.Certificado;
  Componente.ConfigurarSoftwareHouse(Configuracao.CpnjSH, Configuracao.TokenSH);
end;

function TeSocial.consultarEventos(AEvento: WideString): IspdRetConsultarLote;
var
  retorno: IspdRetConsultarLote;
begin
  retorno := Componente.ConsultarLoteEventos(AEvento);
  Result := retorno;
end;

constructor TeSocial.Create;
begin
  inherited;
  Componente := TspdESocialClientX.create(nil);
//  Config := TConfiguracoes.Create();
end;

function TeSocial.enviarEvento(const AAcao: Integer; const ATx2: WideString; const idGrupoEvento: SmallInt): IspdRetEnviarLoteEventos;
begin

end;

function TeSocial.listarCertificados: string;
begin
  Result := Componente.ListarCertificados(#13#10);
end;

end.

